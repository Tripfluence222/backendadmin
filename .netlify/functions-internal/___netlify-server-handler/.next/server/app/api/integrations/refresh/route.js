"use strict";(()=>{var e={};e.id=4079,e.ids=[4079],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},2836:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>S,requestAsyncStorage:()=>v,routeModule:()=>A,serverHooks:()=>b,staticGenerationAsyncStorage:()=>T});var s={};r.r(s),r.d(s,{POST:()=>R});var a=r(49303),n=r(88716),o=r(60670),i=r(87070),c=r(88879),u=r(9487),l=r(31402),d=r(90455),f=r(14749),h=r(67297),p=r(57435),m=r(1964);class y{static{this.API_BASE=m.OB.GBP_API_BASE||"https://mybusiness.googleapis.com"}static{this.API_VERSION="v4"}static async makeRequest(e,t,r={}){let s=`${this.API_BASE}/${this.API_VERSION}${e}`;try{let e=await fetch(s,{...r,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,...r.headers}}),a=await e.json();if(!e.ok)throw{code:a.error?.code||"UNKNOWN_ERROR",message:a.error?.message||`HTTP ${e.status}`,retryable:this.isRetryableError(e.status,a.error?.code),statusCode:e.status};return a}catch(t){if(t instanceof Error&&"code"in t)throw t;throw p.k.error(`Google Business API request failed: ${e}`,t),{code:"NETWORK_ERROR",message:t.message,retryable:!0}}}static isRetryableError(e,t){return 429===e||e>=500||["SERVICE_UNAVAILABLE","INTERNAL_ERROR","DEADLINE_EXCEEDED"].includes(t||"")}static async createPost(e,t,r){let s=await this.makeRequest(`/${e}/localPosts`,t,{method:"POST",body:JSON.stringify({summary:r.summary,callToAction:r.callToActionUrl?{actionType:"LEARN_MORE",url:r.callToActionUrl}:void 0,media:r.media?.map(e=>({mediaFormat:e.mediaFormat,sourceUrl:e.sourceUrl}))})});return{name:s.name,url:`https://business.google.com/posts/${s.name.split("/").pop()}`}}static async createEventPost(e,t,r){let s=await this.makeRequest(`/${e}/localPosts`,t,{method:"POST",body:JSON.stringify({summary:r.summary||r.title,event:{title:r.title,schedule:r.schedule?{startDate:r.schedule.startDate,endDate:r.schedule.endDate,startTime:r.schedule.startTime,endTime:r.schedule.endTime}:void 0}})});return{name:s.name,url:`https://business.google.com/posts/${s.name.split("/").pop()}`}}static async updatePost(e,t,r,s){let a=await this.makeRequest(`/${r}`,t,{method:"PATCH",body:JSON.stringify({summary:s.summary,callToAction:s.callToActionUrl?{actionType:"LEARN_MORE",url:s.callToActionUrl}:void 0,media:s.media?.map(e=>({mediaFormat:e.mediaFormat,sourceUrl:e.sourceUrl}))})});return{name:a.name,url:`https://business.google.com/posts/${a.name.split("/").pop()}`}}static async deletePost(e,t,r){await this.makeRequest(`/${r}`,t,{method:"DELETE"})}static async getAccounts(e){return(await this.makeRequest("/accounts",e)).accounts||[]}static async getLocations(e,t){return(await this.makeRequest(`/${t}/locations`,e)).locations||[]}static async getLocationInfo(e,t){return this.makeRequest(`/${t}`,e)}static async getPosts(e,t){return(await this.makeRequest(`/${t}/localPosts`,e)).localPosts||[]}static async validateToken(e){try{return await this.getAccounts(e),!0}catch(e){return!1}}static async refreshToken(e){let t=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:m.OB.GOOGLE_CLIENT_ID,client_secret:m.OB.GOOGLE_CLIENT_SECRET,refresh_token:e,grant_type:"refresh_token"})});if(!t.ok)throw Error(`Token refresh failed: ${t.statusText}`);return t.json()}}class k{static{this.API_BASE="https://www.eventbriteapi.com"}static async makeRequest(e,t,r={}){let s=`${this.API_BASE}${e}`;try{let e=await fetch(s,{...r,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,...r.headers}}),a=await e.json();if(!e.ok)throw{code:a.error||"UNKNOWN_ERROR",message:a.error_description||`HTTP ${e.status}`,retryable:this.isRetryableError(e.status,a.error),statusCode:e.status};return a}catch(t){if(t instanceof Error&&"code"in t)throw t;throw p.k.error(`Eventbrite API request failed: ${e}`,t),{code:"NETWORK_ERROR",message:t.message,retryable:!0}}}static isRetryableError(e,t){return 429===e||e>=500||["SERVICE_UNAVAILABLE","INTERNAL_ERROR","TEMPORARY_ISSUE"].includes(t||"")}static async createEvent(e,t,r){let s=await this.makeRequest("/v3/events/",e,{method:"POST",body:JSON.stringify({event:{...r,organizer_id:t}})});return{id:s.id,url:s.url}}static async updateEvent(e,t,r){let s=await this.makeRequest(`/v3/events/${t}/`,e,{method:"POST",body:JSON.stringify({event:r})});return{id:s.id,url:s.url}}static async publishEvent(e,t){let r=await this.makeRequest(`/v3/events/${t}/publish/`,e,{method:"POST"});return{id:r.id,url:r.url}}static async unpublishEvent(e,t){let r=await this.makeRequest(`/v3/events/${t}/unpublish/`,e,{method:"POST"});return{id:r.id,url:r.url}}static async deleteEvent(e,t){await this.makeRequest(`/v3/events/${t}/`,e,{method:"DELETE"})}static async getEvent(e,t){return this.makeRequest(`/v3/events/${t}/`,e)}static async getEvents(e,t){return(await this.makeRequest(`/v3/organizers/${t}/events/`,e)).events||[]}static async createVenue(e,t,r){return{id:(await this.makeRequest("/v3/venues/",e,{method:"POST",body:JSON.stringify({venue:{...r,organizer_id:t}})})).id}}static async getVenues(e,t){return(await this.makeRequest(`/v3/organizers/${t}/venues/`,e)).venues||[]}static async getOrganizations(e){return(await this.makeRequest("/v3/users/me/organizations/",e)).organizations||[]}static async getOrganization(e,t){return this.makeRequest(`/v3/organizations/${t}/`,e)}static async getUser(e){return this.makeRequest("/v3/users/me/",e)}static async validateToken(e){try{return await this.getUser(e),!0}catch(e){return!1}}static async refreshToken(e){let t=await fetch("https://www.eventbrite.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:m.OB.EVENTBRITE_CLIENT_ID,client_secret:m.OB.EVENTBRITE_CLIENT_SECRET,refresh_token:e})});if(!t.ok)throw Error(`Token refresh failed: ${t.statusText}`);return t.json()}}class w{static{this.API_BASE="https://api.meetup.com"}static async makeRequest(e,t,r={}){let s=`${this.API_BASE}${e}`;try{let e=await fetch(s,{...r,headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,...r.headers}}),a=await e.json();if(!e.ok)throw{code:a.code||"UNKNOWN_ERROR",message:a.details||a.problem||`HTTP ${e.status}`,retryable:this.isRetryableError(e.status,a.code),statusCode:e.status};return a}catch(t){if(t instanceof Error&&"code"in t)throw t;throw p.k.error(`Meetup API request failed: ${e}`,t),{code:"NETWORK_ERROR",message:t.message,retryable:!0}}}static isRetryableError(e,t){return 429===e||e>=500||["SERVICE_UNAVAILABLE","INTERNAL_ERROR","TEMPORARY_ISSUE"].includes(t||"")}static async createEvent(e,t,r){let s=await this.makeRequest(`/${t}/events`,e,{method:"POST",body:JSON.stringify(r)});return{id:s.id.toString(),url:s.link}}static async updateEvent(e,t,r,s){let a=await this.makeRequest(`/${t}/events/${r}`,e,{method:"PATCH",body:JSON.stringify(s)});return{id:a.id.toString(),url:a.link}}static async deleteEvent(e,t,r){await this.makeRequest(`/${t}/events/${r}`,e,{method:"DELETE"})}static async getEvent(e,t,r){return this.makeRequest(`/${t}/events/${r}`,e)}static async getEvents(e,t){return await this.makeRequest(`/${t}/events`,e)||[]}static async getGroup(e,t){return this.makeRequest(`/${t}`,e)}static async getGroups(e){return await this.makeRequest("/self/groups",e)||[]}static async getUser(e){return this.makeRequest("/members/self",e)}static async getMember(e,t){return this.makeRequest(`/members/${t}`,e)}static async getCategories(e){return await this.makeRequest("/categories",e)||[]}static async searchGroups(e,t,r){let s=new URLSearchParams({text:t,...r&&{location:r}});return await this.makeRequest(`/find/groups?${s}`,e)||[]}static async validateToken(e){try{return await this.getUser(e),!0}catch(e){return!1}}static async refreshToken(e){let t=await fetch("https://secure.meetup.com/oauth2/access",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:m.OB.MEETUP_CLIENT_ID,client_secret:m.OB.MEETUP_CLIENT_SECRET,refresh_token:e})});if(!t.ok)throw Error(`Token refresh failed: ${t.statusText}`);return t.json()}static formatEventForMeetup(e){let t=new Date(e.startDate).getTime(),r=e.endDate?new Date(e.endDate).getTime():null;return{name:e.title,time:t,duration:r?r-t:void 0,description:e.description,venue:e.location?{name:e.location.name||e.location.address,address_1:e.location.address,city:e.location.city,state:e.location.state,country:e.location.country,lat:e.location.latitude,lon:e.location.longitude}:void 0,rsvp_limit:e.capacity,publish_status:"published"}}}class E{static async refreshToken(e){try{let t;let r=await u.db.socialAccount.findUnique({where:{id:e}});if(!r)return{success:!1,error:"Account not found"};if(!r.refreshToken)return{success:!1,error:"No refresh token available"};let s=await (0,h.sw)(r.refreshToken);switch(r.provider){case"GOOGLE_BUSINESS":t=await y.refreshToken(s);break;case"EVENTBRITE":t=await k.refreshToken(s);break;case"MEETUP":t=await w.refreshToken(s);break;case"FACEBOOK_PAGE":case"INSTAGRAM_BUSINESS":return{success:!1,error:"Facebook tokens are long-lived"};default:return{success:!1,error:`Unsupported provider: ${r.provider}`}}let a=await (0,h.n0)(t.access_token),n=t.refresh_token?await (0,h.n0)(t.refresh_token):r.refreshToken,o=t.expires_in?new Date(Date.now()+1e3*t.expires_in):null;return await u.db.socialAccount.update({where:{id:e},data:{accessToken:a,refreshToken:n,expiresAt:o,updatedAt:new Date}}),p.k.info(`Token refreshed successfully for account ${e}`),{success:!0,newAccessToken:t.access_token,newRefreshToken:t.refresh_token,expiresAt:o}}catch(t){return p.k.error(`Token refresh failed for account ${e}:`,t),{success:!1,error:t.message}}}static async refreshExpiredTokens(){let e=new Date,t=await u.db.socialAccount.findMany({where:{expiresAt:{lt:e},refreshToken:{not:null},isActive:!0}}),r=0,s=0,a=[];for(let e of t){let t=await this.refreshToken(e.id);t.success?r++:(s++,a.push(`${e.provider} (${e.accountName}): ${t.error}`))}return p.k.info(`Token refresh completed: ${r} refreshed, ${s} failed`),{refreshed:r,failed:s,errors:a}}static async getValidToken(e){try{let t=await u.db.socialAccount.findUnique({where:{id:e}});if(!t||!t.isActive)return null;if(t.expiresAt&&t.expiresAt<new Date){let t=await this.refreshToken(e);if(t.success&&t.newAccessToken)return t.newAccessToken;return null}return await (0,h.sw)(t.accessToken)}catch(t){return p.k.error(`Failed to get valid token for account ${e}:`,t),null}}static async validateAndRefreshToken(e){try{let t=await this.getValidToken(e);if(!t)return!1;let s=await u.db.socialAccount.findUnique({where:{id:e}});if(!s)return!1;let a=!1;switch(s.provider){case"FACEBOOK_PAGE":case"INSTAGRAM_BUSINESS":let{FacebookProvider:n}=await r.e(2458).then(r.bind(r,92458));a=await n.validateToken(t);break;case"GOOGLE_BUSINESS":a=await y.validateToken(t);break;case"EVENTBRITE":a=await k.validateToken(t);break;case"MEETUP":a=await w.validateToken(t)}if(!a)return(await this.refreshToken(e)).success;return!0}catch(t){return p.k.error(`Token validation failed for account ${e}:`,t),!1}}}let g=c.Ryn({accountId:c.Z_8().cuid()});async function R(e){try{let t=await (0,d.mk)(e);(0,d.Ql)(t,"integrations:refresh");let r=await e.json(),s=g.parse(r),a=await u.db.socialAccount.findUnique({where:{id:s.accountId},include:{business:!0}});if(!a)return i.NextResponse.json({error:"Account not found"},{status:404});if(t.businessId!==a.businessId)return i.NextResponse.json({error:"Access denied"},{status:403});if(!a.refreshToken)return(0,l.lI)("No refresh token available for this account");let n=await E.refreshToken(s.accountId);if(!n.success)return(0,l.lI)(`Token refresh failed: ${n.error}`);return await (0,f.ar)(t.id,"user",f.sZ.PROVIDER_REFRESHED,"social_account",s.accountId,a.businessId,{provider:a.provider,accountName:a.accountName,newExpiresAt:n.expiresAt}),(0,l.ok)({message:"Token refreshed successfully",accountId:s.accountId,expiresAt:n.expiresAt})}catch(e){if(e instanceof c.jmq)return(0,l.lI)("Invalid refresh data",e.errors);return(0,l.Vm)("Failed to refresh token",e)}}let A=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/integrations/refresh/route",pathname:"/api/integrations/refresh",filename:"route",bundlePath:"app/api/integrations/refresh/route"},resolvedPagePath:"/Users/kumar/Business admin/tripfluence-admin/app/api/integrations/refresh/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:T,serverHooks:b}=A,_="/api/integrations/refresh/route";function S(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:T})}},90455:(e,t,r)=>{r.d(t,{Ql:()=>i,mk:()=>o,ts:()=>n});var s=r(71615),a=r(9487);async function n(){try{let e=(0,s.cookies)(),t=e.get("user-id")?.value;if(!t)return null;let r=await a.db.user.findUnique({where:{id:t},select:{id:!0,email:!0,firstName:!0,lastName:!0,businessId:!0,isActive:!0,lastLoginAt:!0}});if(!r||!r.isActive)return null;return r}catch(e){return console.error("Error getting current user:",e),null}}async function o(){let e=await n();if(!e)throw Error("Authentication required");return e}async function i(e){return await o()}},31402:(e,t,r)=>{r.d(t,{Vm:()=>i,lI:()=>n,ok:()=>a,v6:()=>o});var s=r(87070);let a=(e,t)=>s.NextResponse.json({success:!0,data:e,...t}),n=(e,t)=>s.NextResponse.json({success:!1,error:e,errors:t},{status:400}),o=(e="Not found")=>s.NextResponse.json({success:!1,error:e},{status:404}),i=(e="Internal server error",t)=>(console.error("Server error:",t),s.NextResponse.json({success:!1,error:e,...!1},{status:500}))},71615:(e,t,r)=>{var s=r(88757);r.o(s,"cookies")&&r.d(t,{cookies:function(){return s.cookies}})},33085:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"DraftMode",{enumerable:!0,get:function(){return n}});let s=r(45869),a=r(6278);class n{get isEnabled(){return this._provider.isEnabled}enable(){let e=s.staticGenerationAsyncStorage.getStore();return e&&(0,a.trackDynamicDataAccessed)(e,"draftMode().enable()"),this._provider.enable()}disable(){let e=s.staticGenerationAsyncStorage.getStore();return e&&(0,a.trackDynamicDataAccessed)(e,"draftMode().disable()"),this._provider.disable()}constructor(e){this._provider=e}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},88757:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{cookies:function(){return f},draftMode:function(){return h},headers:function(){return d}});let s=r(68996),a=r(53047),n=r(92044),o=r(72934),i=r(33085),c=r(6278),u=r(45869),l=r(54580);function d(){let e="headers",t=u.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return a.HeadersAdapter.seal(new Headers({}));(0,c.trackDynamicDataAccessed)(t,e)}return(0,l.getExpectedRequestStore)(e).headers}function f(){let e="cookies",t=u.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return s.RequestCookiesAdapter.seal(new n.RequestCookies(new Headers({})));(0,c.trackDynamicDataAccessed)(t,e)}let r=(0,l.getExpectedRequestStore)(e),a=o.actionAsyncStorage.getStore();return(null==a?void 0:a.isAction)||(null==a?void 0:a.isAppRoute)?r.mutableCookies:r.cookies}function h(){let e=(0,l.getExpectedRequestStore)("draftMode");return new i.DraftMode(e.draftMode)}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},53047:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{HeadersAdapter:function(){return n},ReadonlyHeadersError:function(){return a}});let s=r(38238);class a extends Error{constructor(){super("Headers cannot be modified. Read more: https://nextjs.org/docs/app/api-reference/functions/headers")}static callable(){throw new a}}class n extends Headers{constructor(e){super(),this.headers=new Proxy(e,{get(t,r,a){if("symbol"==typeof r)return s.ReflectAdapter.get(t,r,a);let n=r.toLowerCase(),o=Object.keys(e).find(e=>e.toLowerCase()===n);if(void 0!==o)return s.ReflectAdapter.get(t,o,a)},set(t,r,a,n){if("symbol"==typeof r)return s.ReflectAdapter.set(t,r,a,n);let o=r.toLowerCase(),i=Object.keys(e).find(e=>e.toLowerCase()===o);return s.ReflectAdapter.set(t,i??r,a,n)},has(t,r){if("symbol"==typeof r)return s.ReflectAdapter.has(t,r);let a=r.toLowerCase(),n=Object.keys(e).find(e=>e.toLowerCase()===a);return void 0!==n&&s.ReflectAdapter.has(t,n)},deleteProperty(t,r){if("symbol"==typeof r)return s.ReflectAdapter.deleteProperty(t,r);let a=r.toLowerCase(),n=Object.keys(e).find(e=>e.toLowerCase()===a);return void 0===n||s.ReflectAdapter.deleteProperty(t,n)}})}static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"append":case"delete":case"set":return a.callable;default:return s.ReflectAdapter.get(e,t,r)}}})}merge(e){return Array.isArray(e)?e.join(", "):e}static from(e){return e instanceof Headers?e:new n(e)}append(e,t){let r=this.headers[e];"string"==typeof r?this.headers[e]=[r,t]:Array.isArray(r)?r.push(t):this.headers[e]=t}delete(e){delete this.headers[e]}get(e){let t=this.headers[e];return void 0!==t?this.merge(t):null}has(e){return void 0!==this.headers[e]}set(e,t){this.headers[e]=t}forEach(e,t){for(let[r,s]of this.entries())e.call(t,s,r,this)}*entries(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase(),r=this.get(t);yield[t,r]}}*keys(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase();yield t}}*values(){for(let e of Object.keys(this.headers)){let t=this.get(e);yield t}}[Symbol.iterator](){return this.entries()}}},68996:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{MutableRequestCookiesAdapter:function(){return d},ReadonlyRequestCookiesError:function(){return o},RequestCookiesAdapter:function(){return i},appendMutableCookies:function(){return l},getModifiedCookieValues:function(){return u}});let s=r(92044),a=r(38238),n=r(45869);class o extends Error{constructor(){super("Cookies can only be modified in a Server Action or Route Handler. Read more: https://nextjs.org/docs/app/api-reference/functions/cookies#cookiessetname-value-options")}static callable(){throw new o}}class i{static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"clear":case"delete":case"set":return o.callable;default:return a.ReflectAdapter.get(e,t,r)}}})}}let c=Symbol.for("next.mutated.cookies");function u(e){let t=e[c];return t&&Array.isArray(t)&&0!==t.length?t:[]}function l(e,t){let r=u(t);if(0===r.length)return!1;let a=new s.ResponseCookies(e),n=a.getAll();for(let e of r)a.set(e);for(let e of n)a.set(e);return!0}class d{static wrap(e,t){let r=new s.ResponseCookies(new Headers);for(let t of e.getAll())r.set(t);let o=[],i=new Set,u=()=>{let e=n.staticGenerationAsyncStorage.getStore();if(e&&(e.pathWasRevalidated=!0),o=r.getAll().filter(e=>i.has(e.name)),t){let e=[];for(let t of o){let r=new s.ResponseCookies(new Headers);r.set(t),e.push(r.toString())}t(e)}};return new Proxy(r,{get(e,t,r){switch(t){case c:return o;case"delete":return function(...t){i.add("string"==typeof t[0]?t[0]:t[0].name);try{e.delete(...t)}finally{u()}};case"set":return function(...t){i.add("string"==typeof t[0]?t[0]:t[0].name);try{return e.set(...t)}finally{u()}};default:return a.ReflectAdapter.get(e,t,r)}}})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,147,5972,9544],()=>r(2836));module.exports=s})();