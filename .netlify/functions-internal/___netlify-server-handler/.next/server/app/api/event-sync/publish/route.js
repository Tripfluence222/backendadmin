(()=>{var e={};e.id=4137,e.ids=[4137],e.modules={4665:e=>{function t(e){return Promise.resolve().then(()=>{var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t})}t.keys=()=>[],t.resolve=t,t.id=4665,e.exports=t},53524:e=>{"use strict";e.exports=require("@prisma/client")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},85807:e=>{"use strict";e.exports=require("module")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},76162:e=>{"use strict";e.exports=require("stream")},74026:e=>{"use strict";e.exports=require("string_decoder")},82452:e=>{"use strict";e.exports=require("tls")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},6162:e=>{"use strict";e.exports=require("worker_threads")},6005:e=>{"use strict";e.exports=require("node:crypto")},9469:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>D,requestAsyncStorage:()=>R,routeModule:()=>T,serverHooks:()=>m,staticGenerationAsyncStorage:()=>S});var s={};r.r(s),r.d(s,{POST:()=>_});var a=r(49303),n=r(88716),i=r(60670),o=r(87070),l=r(88879),d=r(9487),c=r(14749),u=r(19163),E=r(29837);let p=l.Ryn({businessId:l.Z_8().cuid(),listingId:l.Z_8().cuid(),platforms:l.IXX(l.KmV(["facebook","eventbrite","meetup"])).min(1),forceUpdate:l.O72().default(!1),meetupGroupUrlName:l.Z_8().optional()});async function _(e){try{let t=await e.json(),r=p.safeParse(t);if(!r.success)return o.NextResponse.json({error:"Invalid request data",details:r.error.errors},{status:400});let{businessId:s,listingId:a,platforms:n,forceUpdate:i,meetupGroupUrlName:l}=r.data,_=await u.hS.getCurrentUser(e);if(!_)return o.NextResponse.json({error:"Unauthorized"},{status:401});if(!await u.hS.checkPermission(_.id,s,["ADMIN","MANAGER","INFLUENCER"]))return o.NextResponse.json({error:"Insufficient permissions"},{status:403});if(!await d.db.listing.findFirst({where:{id:a,businessId:s}}))return o.NextResponse.json({error:"Listing not found or access denied"},{status:404});let T="true"===process.env.FEATURE_REAL_PROVIDERS,R=await d.db.eventSync.findFirst({where:{businessId:s,listingId:a}});if(R&&!i)return o.NextResponse.json({error:"Event sync already exists. Use forceUpdate=true to overwrite."},{status:409});return R=R?await d.db.eventSync.update({where:{id:R.id},data:{platforms:n.map(e=>{switch(e){case"facebook":return"FACEBOOK_PAGE";case"eventbrite":return"EVENTBRITE";case"meetup":return"MEETUP";default:return e.toUpperCase()}}),lastSyncStatus:"PENDING",lastSyncAt:null,lastSyncError:null,syncData:{},externalIds:[]}}):await d.db.eventSync.create({data:{businessId:s,listingId:a,platforms:n.map(e=>{switch(e){case"facebook":return"FACEBOOK_PAGE";case"eventbrite":return"EVENTBRITE";case"meetup":return"MEETUP";default:return e.toUpperCase()}}),lastSyncStatus:"PENDING",syncData:{},externalIds:[]}}),T?await (0,E.DJ)({eventSyncId:R.id,direction:"export",forceUpdate:i}):await d.db.eventSync.update({where:{id:R.id},data:{lastSyncStatus:"SUCCESS",lastSyncAt:new Date,externalIds:n.map(e=>`mock-${e}-${Date.now()}`),syncData:{mock:!0,platforms:n.reduce((e,t)=>(e[t]={eventUrl:`https://${t}.com/events/mock-${Date.now()}`},e),{})}}}),await (0,c.ar)(_.id,"user","EVENT_SYNC_INITIATED","EventSync",R.id,s,{listingId:a,platforms:n,forceUpdate:i,useRealProviders:T,meetupGroupUrlName:l}),o.NextResponse.json({success:!0,eventSync:{id:R.id,listingId:R.listingId,platforms:R.platforms,lastSyncStatus:R.lastSyncStatus,lastSyncAt:R.lastSyncAt,externalIds:R.externalIds,syncData:R.syncData,createdAt:R.createdAt,updatedAt:R.updatedAt}})}catch(e){return console.error("Event sync publish error:",e),o.NextResponse.json({error:"Failed to publish event sync"},{status:500})}}let T=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/event-sync/publish/route",pathname:"/api/event-sync/publish",filename:"route",bundlePath:"app/api/event-sync/publish/route"},resolvedPagePath:"/Users/kumar/Business admin/tripfluence-admin/app/api/event-sync/publish/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:R,staticGenerationAsyncStorage:S,serverHooks:m}=T,A="/api/event-sync/publish/route";function D(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:S})}},29837:(e,t,r)=>{"use strict";r.d(t,{BN:()=>p,DJ:()=>_,FH:()=>D,Y$:()=>A,aL:()=>T});var s=r(26608),a=r(1964),n=r(57435);let i=a.OB.REDIS_URL?{host:new URL(a.OB.REDIS_URL).hostname,port:parseInt(new URL(a.OB.REDIS_URL).port),password:new URL(a.OB.REDIS_URL).password}:null,o=i?new s.ci("social",{connection:i}):null,l=i?new s.ci("event-sync",{connection:i}):null,d=i?new s.ci("webhook",{connection:i}):null,c=i?new s.ci("email",{connection:i}):null,u=i?new s.ci("sms",{connection:i}):null,E=i?new s.ci("space",{connection:i}):null,p=async(e,t)=>o?o.add("publish",e,{delay:e.scheduledAt?new Date(e.scheduledAt).getTime()-Date.now():0,attempts:3,backoff:{type:"exponential",delay:2e3},...t}):(n.k.warn("Redis not configured, skipping social publish job"),null),_=async(e,t)=>l?l.add("sync",e,{attempts:3,backoff:{type:"exponential",delay:5e3},...t}):(n.k.warn("Redis not configured, skipping event sync job"),null),T=async(e,t)=>d?d.add("dispatch",e,{attempts:5,backoff:{type:"exponential",delay:1e3},...t}):(n.k.warn("Redis not configured, skipping webhook job"),null),R=async(e,t)=>c?c.add("send",e,{attempts:3,backoff:{type:"exponential",delay:2e3},...t}):(n.k.warn("Redis not configured, skipping email job"),null),S=async(e,t)=>u?u.add("send",e,{attempts:3,backoff:{type:"exponential",delay:2e3},...t}):(n.k.warn("Redis not configured, skipping SMS job"),null),m=async(e,t)=>E?E.add("hold-expire",e,{attempts:1,...t}):(n.k.warn("Redis not configured, skipping space hold expire job"),null),A=async(e,t,r)=>{switch(e){case"socialPublish":return p(t,r);case"eventSync":return _(t,r);case"webhook":return T(t,r);case"email":return R(t,r);case"sms":return S(t,r);case"spaceHoldExpire":return m(t,r);default:throw Error(`Unknown queue: ${e}`)}},D=async()=>{if(!a.OB.REDIS_URL)return{social:{waiting:0,active:0,completed:0,failed:0,delayed:0},eventSync:{waiting:0,active:0,completed:0,failed:0,delayed:0},webhook:{waiting:0,active:0,completed:0,failed:0,delayed:0},email:{waiting:0,active:0,completed:0,failed:0,delayed:0},sms:{waiting:0,active:0,completed:0,failed:0,delayed:0},space:{waiting:0,active:0,completed:0,failed:0,delayed:0}};let[e,t,r,s,n,i]=await Promise.all([o.getJobCounts(),l.getJobCounts(),d.getJobCounts(),c.getJobCounts(),u.getJobCounts(),E.getJobCounts()]);return{social:e,eventSync:t,webhook:r,email:s,sms:n,space:i}}},14749:(e,t,r)=>{"use strict";r.d(t,{ar:()=>o,sZ:()=>i});var s=r(9487),a=r(57435),n=r(60581);let i={LISTING_CREATED:"listing.created",LISTING_UPDATED:"listing.updated",LISTING_DELETED:"listing.deleted",LISTING_PUBLISHED:"listing.published",LISTING_UNPUBLISHED:"listing.unpublished",ORDER_CREATED:"order.created",ORDER_UPDATED:"order.updated",ORDER_CANCELLED:"order.cancelled",ORDER_REFUNDED:"order.refunded",SLOT_CREATED:"slot.created",SLOT_UPDATED:"slot.updated",SLOT_DELETED:"slot.deleted",SLOTS_IMPORTED:"slots.imported",SLOTS_EXPORTED:"slots.exported",WIDGET_CREATED:"widget.created",WIDGET_UPDATED:"widget.updated",WIDGET_DELETED:"widget.deleted",WIDGET_GENERATED:"widget.generated",SOCIAL_POST_CREATED:"social.post.created",SOCIAL_POST_PUBLISHED:"social.post.published",SOCIAL_POST_FAILED:"social.post.failed",SOCIAL_TEST_POST:"social.test.post",SOCIAL_ACCOUNT_CONNECTED:"social.account.connected",SOCIAL_ACCOUNT_DISCONNECTED:"social.account.disconnected",PROVIDER_CONNECTED:"provider.connected",PROVIDER_DISCONNECTED:"provider.disconnected",PROVIDER_RECONNECT_REQUESTED:"provider.reconnect.requested",PROVIDER_REFRESHED:"provider.refreshed",EVENT_SYNC_CREATED:"event.sync.created",EVENT_SYNC_UPDATED:"event.sync.updated",EVENT_SYNC_DELETED:"event.sync.deleted",EVENT_SYNC_PUBLISHED:"event.sync.published",EVENT_SYNC_IMPORTED:"event.sync.imported",EVENT_PUBLISHED:"event.published",EVENT_UPDATED:"event.updated",EVENT_FAILED:"event.failed",EVENT_TEST_PUBLISH:"event.test.publish",COUPON_CREATED:"coupon.created",COUPON_UPDATED:"coupon.updated",COUPON_DELETED:"coupon.deleted",AFFILIATE_CREATED:"affiliate.created",AFFILIATE_UPDATED:"affiliate.updated",AFFILIATE_DELETED:"affiliate.deleted",SETTINGS_UPDATED:"settings.updated",USER_CREATED:"user.created",USER_UPDATED:"user.updated",USER_DELETED:"user.deleted",WEBHOOK_CREATED:"webhook.created",WEBHOOK_UPDATED:"webhook.updated",WEBHOOK_DELETED:"webhook.deleted",API_KEY_CREATED:"api.key.created",API_KEY_DELETED:"api.key.deleted",LOGIN:"user.login",LOGOUT:"user.logout",PASSWORD_CHANGED:"user.password.changed",PERMISSION_CHANGED:"user.permission.changed"},o=async(e,t,r,i,o,l,d={},c)=>{try{let u=await s.db.auditLog.create({data:{id:(0,n.x0)(),actorId:e,actorType:t,action:r,entityType:i,entityId:o,businessId:l,metadata:JSON.stringify(d),ipAddress:c?.ipAddress,userAgent:c?.userAgent}});return a.k.info(`Audit log created: ${r} on ${i}:${o} by ${t}:${e}`),u}catch(e){throw a.k.error("Failed to create audit log entry:",e),e}}},9487:(e,t,r)=>{"use strict";r.d(t,{db:()=>o});var s=r(53524),a=r(1964);let n=globalThis,i=()=>({$queryRaw:()=>Promise.resolve([]),$executeRaw:()=>Promise.resolve(0),$transaction:e=>e({}),user:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)},business:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)},space:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)},socialAccount:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)},webhookDelivery:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)},auditLog:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)},spaceAvailability:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)},spaceRequest:{findMany:()=>Promise.resolve([]),findFirst:()=>Promise.resolve(null)}}),o=(()=>{process.env.SKIP_ENV_VALIDATION;try{return n.prisma??new s.PrismaClient({log:"development"===a.OB.NODE_ENV?["query","error","warn"]:["error"],datasources:{db:{url:a.OB.DATABASE_URL}}})}catch(e){return console.warn("Database connection failed during build, using mock database:",e),i()}return n.prisma??new s.PrismaClient({log:"development"===a.OB.NODE_ENV?["query","error","warn"]:["error"],datasources:{db:{url:a.OB.DATABASE_URL}}})})();"production"!==a.OB.NODE_ENV&&(n.prisma=o)},1964:(e,t,r)=>{"use strict";r.d(t,{OB:()=>n});var s=r(88879);let a=s.Ryn({DATABASE_URL:s.Z_8().url("Invalid database URL"),REDIS_URL:s.Z_8().url("Invalid Redis URL").optional(),JWT_SECRET:s.Z_8().min(32,"JWT secret must be at least 32 characters"),NEXTAUTH_SECRET:s.Z_8().min(32,"NextAuth secret must be at least 32 characters").optional(),NEXTAUTH_URL:s.Z_8().url("Invalid NextAuth URL").optional(),STRIPE_SECRET_KEY:s.Z_8().startsWith("sk_","Invalid Stripe secret key").optional(),STRIPE_PUBLISHABLE_KEY:s.Z_8().startsWith("pk_","Invalid Stripe publishable key").optional(),STRIPE_WEBHOOK_SECRET:s.Z_8().optional(),RAZORPAY_KEY_ID:s.Z_8().optional(),RAZORPAY_KEY_SECRET:s.Z_8().optional(),RAZORPAY_WEBHOOK_SECRET:s.Z_8().optional(),WEBHOOK_SECRET:s.Z_8().min(32,"Webhook secret must be at least 32 characters"),FACEBOOK_APP_ID:s.Z_8().optional(),FACEBOOK_APP_SECRET:s.Z_8().optional(),FACEBOOK_PAGE_CONFIG_ID:s.Z_8().optional(),INSTAGRAM_CONFIG_ID:s.Z_8().optional(),GOOGLE_CLIENT_ID:s.Z_8().optional(),GOOGLE_CLIENT_SECRET:s.Z_8().optional(),EVENTBRITE_CLIENT_ID:s.Z_8().optional(),EVENTBRITE_CLIENT_SECRET:s.Z_8().optional(),MEETUP_CLIENT_ID:s.Z_8().optional(),MEETUP_CLIENT_SECRET:s.Z_8().optional(),OAUTH_REDIRECT_BASE:s.Z_8().url("Invalid OAuth redirect base URL").optional(),GRAPH_API_BASE:s.Z_8().url("Invalid Graph API base URL").default("https://graph.facebook.com"),GOOGLE_BUSINESS_API_BASE:s.Z_8().url("Invalid Google Business Profile API base URL").default("https://mybusiness.googleapis.com"),ENCRYPTION_KEY:s.Z_8().length(64,"Encryption key must be 64 hex characters (32 bytes)").optional(),FEATURE_REAL_PROVIDERS:s.Z_8().transform(e=>"true"===e).default("false"),SMTP_HOST:s.Z_8().optional(),SMTP_PORT:s.Z_8().transform(Number).optional(),SMTP_USER:s.Z_8().optional(),SMTP_PASSWORD:s.Z_8().optional(),SMTP_FROM:s.Z_8().email("Invalid SMTP from email").optional(),TWILIO_ACCOUNT_SID:s.Z_8().optional(),TWILIO_AUTH_TOKEN:s.Z_8().optional(),TWILIO_PHONE_NUMBER:s.Z_8().optional(),AWS_ACCESS_KEY_ID:s.Z_8().optional(),AWS_SECRET_ACCESS_KEY:s.Z_8().optional(),AWS_REGION:s.Z_8().optional(),AWS_S3_BUCKET:s.Z_8().optional(),SENTRY_DSN:s.Z_8().url("Invalid Sentry DSN").optional(),NODE_ENV:s.KmV(["development","production","test"]).default("development"),PORT:s.Z_8().transform(Number).default("3000")}),n=(()=>{if("true"===process.env.SKIP_ENV_VALIDATION)return{DATABASE_URL:process.env.DATABASE_URL||"postgresql://dummy:dummy@localhost:5432/dummy",JWT_SECRET:process.env.JWT_SECRET||"dummy-jwt-secret-key-minimum-32-characters-long",WEBHOOK_SECRET:process.env.WEBHOOK_SECRET||"dummy-webhook-secret-key-minimum-32-characters-long",NODE_ENV:"production",PORT:process.env.PORT||"3000",FEATURE_REAL_PROVIDERS:!1,GRAPH_API_BASE:"https://graph.facebook.com",GOOGLE_BUSINESS_API_BASE:"https://mybusiness.googleapis.com"};try{return a.parse(process.env)}catch(e){if(e instanceof s.jmq&&e.errors){let t=e.errors.filter(e=>"invalid_type"===e.code&&"undefined"===e.received).map(e=>e.path.join(".")),r=e.errors.filter(e=>"invalid_type"!==e.code).map(e=>`${e.path.join(".")}: ${e.message}`),s="Environment validation failed:\n";throw t.length>0&&(s+=`
Missing required variables:
${t.map(e=>`  - ${e}`).join("\n")}`),r.length>0&&(s+=`
Invalid variables:
${r.map(e=>`  - ${e}`).join("\n")}`),Error(s)}throw e}})();n.NODE_ENV,n.NODE_ENV,n.NODE_ENV},60581:(e,t,r)=>{"use strict";r.d(t,{x0:()=>s.x0});var s=r(42549);(0,s.kP)("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",8),(0,s.kP)("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",10),(0,s.kP)("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",8)},57435:(e,t,r)=>{"use strict";r.d(t,{k:()=>s});let s={info:(e,...t)=>{console.log(`[INFO] ${e}`,...t)},warn:(e,...t)=>{console.warn(`[WARN] ${e}`,...t)},error:(e,...t)=>{console.error(`[ERROR] ${e}`,...t)},debug:(e,...t)=>{}}},19163:(e,t,r)=>{"use strict";r.d(t,{hS:()=>l,rt:()=>n});var s=r(9487),a=r(53524);async function n(e,t,r){try{return!!await s.db.roleAssignment.findFirst({where:{userId:e,businessId:t,role:{in:r}}})}catch(e){return console.error("Error checking RBAC:",e),!1}}async function i(e,t){try{let r=await s.db.roleAssignment.findFirst({where:{userId:e,businessId:t}});return r?.role||null}catch(e){return console.error("Error getting user role:",e),null}}async function o(e,t,r){try{let s=await i(e,t);if(!s)return!1;let n={[a.Role.ADMIN]:["spaces.create","spaces.read","spaces.update","spaces.delete","spaces.publish","requests.read","requests.approve","requests.decline","requests.cancel","pricing.manage","availability.manage","payouts.manage","users.manage","settings.manage"],[a.Role.MANAGER]:["spaces.create","spaces.read","spaces.update","spaces.publish","requests.read","requests.approve","requests.decline","requests.cancel","pricing.manage","availability.manage","payouts.view"],[a.Role.STAFF]:["spaces.read","requests.read","requests.cancel","availability.read"],[a.Role.INFLUENCER]:["spaces.read"]};return n[s]?.includes(r)||!1}catch(e){return console.error("Error checking permission:",e),!1}}let l={checkRBAC:n,getUserRole:i,hasPermission:o}},42549:(e,t,r)=>{"use strict";let s,a;r.d(t,{kP:()=>o,x0:()=>l});var n=r(6005);function i(e){!s||s.length<e?(s=Buffer.allocUnsafe(128*e),n.webcrypto.getRandomValues(s),a=0):a+e>s.length&&(n.webcrypto.getRandomValues(s),a=0),a+=e}function o(e,t=21){var r;let n,o;return r=t,o=Math.ceil(1.6*(n=(2<<31-Math.clz32(e.length-1|1))-1)*r/e.length),(t=r)=>{if(!t)return"";let l="";for(;;){var d;let r=(i(d=0|o),s.subarray(a-d,a)),c=o;for(;c--;)if((l+=e[r[c]&n]||"").length>=t)return l}}}function l(e=21){i(e|=0);let t="";for(let r=a-e;r<a;r++)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&s[r]];return t}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,147,5972,6608],()=>r(9469));module.exports=s})();