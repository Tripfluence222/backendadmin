"use strict";(()=>{var e={};e.id=6074,e.ids=[6074],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},41810:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>O,patchFetch:()=>C,requestAsyncStorage:()=>R,routeModule:()=>S,serverHooks:()=>N,staticGenerationAsyncStorage:()=>x});var r={};a.r(r),a.d(r,{GET:()=>m,dynamic:()=>f});var o=a(49303),s=a(88716),n=a(60670),c=a(87070),i=a(88879),u=a(9487),p=a(14749),d=a(53524),l=a(67297);let h=i.Ryn({code:i.Z_8(),state:i.Z_8(),provider:i.jbo(d.SocialProvider)}),f="force-dynamic";async function m(e,{params:t}){let{provider:a}=await t;try{let{searchParams:t}=new URL(e.url),r=t.get("code"),o=t.get("state"),s=h.safeParse({code:r,state:o,provider:a});if(!s.success)return c.NextResponse.redirect(`${process.env.OAUTH_REDIRECT_BASE||"http://localhost:3000"}/social?error=invalid_parameters`);let{code:n,state:i,provider:d}=s.data,f=await u.db.providerAuthState.findUnique({where:{state:i}});if(!f||f.expiresAt<new Date)return c.NextResponse.redirect(`${process.env.OAUTH_REDIRECT_BASE||"http://localhost:3000"}/social?error=invalid_state`);await u.db.providerAuthState.delete({where:{state:i}});let m=await E(d,n);if(!m)return c.NextResponse.redirect(`${process.env.OAUTH_REDIRECT_BASE||"http://localhost:3000"}/social?error=token_exchange_failed`);let _=await v(d,m.accessToken);if(!_)return c.NextResponse.redirect(`${process.env.OAUTH_REDIRECT_BASE||"http://localhost:3000"}/social?error=account_fetch_failed`);let w=(0,l.n0)(m.accessToken),k=m.refreshToken?(0,l.n0)(m.refreshToken):null,T=await u.db.socialAccount.upsert({where:{businessId_provider_accountId:{businessId:f.businessId,provider:d,accountId:_.id}},update:{accountName:_.name,accessToken:w,refreshToken:k,expiresAt:m.expiresAt,scopes:m.scopes,metadata:_.metadata,lastSuccessAt:new Date,lastErrorAt:null},create:{businessId:f.businessId,provider:d,accountId:_.id,accountName:_.name,accessToken:w,refreshToken:k,expiresAt:m.expiresAt,scopes:m.scopes,metadata:_.metadata,lastSuccessAt:new Date}});return await (0,p.ar)(f.userId||"system","user","PROVIDER_CONNECTED","SocialAccount",T.id,f.businessId,{provider:d,accountName:_.name,accountId:_.id}),c.NextResponse.redirect(`${process.env.OAUTH_REDIRECT_BASE||"http://localhost:3000"}/social?success=connected&provider=${d}`)}catch(e){return console.error("OAuth callback error:",e),c.NextResponse.redirect(`${process.env.OAUTH_REDIRECT_BASE||"http://localhost:3000"}/social?error=callback_failed`)}}async function E(e,t){let a=process.env.OAUTH_REDIRECT_BASE||"http://localhost:3000",r=`${a}/api/auth/callback/${e}`;switch(e){case"FACEBOOK_PAGE":case"INSTAGRAM_BUSINESS":return _(t,r);case"GOOGLE_BUSINESS":return w(t,r);case"EVENTBRITE":return k(t,r);case"MEETUP":return T(t,r);default:throw Error(`Unknown provider: ${e}`)}}async function _(e,t){let a=await fetch("https://graph.facebook.com/v18.0/oauth/access_token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:process.env.FACEBOOK_APP_ID||"",client_secret:process.env.FACEBOOK_APP_SECRET||"",redirect_uri:t,code:e})});if(!a.ok)throw Error("Facebook token exchange failed");let r=await a.json(),o=r.expires_in?new Date(Date.now()+1e3*r.expires_in):null;return{accessToken:r.access_token,refreshToken:null,expiresAt:o,scopes:Array.isArray(r.scopes)?r.scopes:[]}}async function w(e,t){let a=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:process.env.GOOGLE_CLIENT_ID||"",client_secret:process.env.GOOGLE_CLIENT_SECRET||"",redirect_uri:t,code:e,grant_type:"authorization_code"})});if(!a.ok)throw Error("Google token exchange failed");let r=await a.json(),o=r.expires_in?new Date(Date.now()+1e3*r.expires_in):null;return{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:o,scopes:r.scope?r.scope.split(" "):[]}}async function k(e,t){let a=await fetch("https://www.eventbrite.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",client_id:process.env.EVENTBRITE_CLIENT_ID||"",client_secret:process.env.EVENTBRITE_CLIENT_SECRET||"",code:e,redirect_uri:t})});if(!a.ok)throw Error("Eventbrite token exchange failed");let r=await a.json(),o=r.expires_in?new Date(Date.now()+1e3*r.expires_in):null;return{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:o,scopes:r.scope?r.scope.split(" "):[]}}async function T(e,t){let a=await fetch("https://secure.meetup.com/oauth2/access",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",client_id:process.env.MEETUP_CLIENT_ID||"",client_secret:process.env.MEETUP_CLIENT_SECRET||"",code:e,redirect_uri:t})});if(!a.ok)throw Error("Meetup token exchange failed");let r=await a.json(),o=r.expires_in?new Date(Date.now()+1e3*r.expires_in):null;return{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:o,scopes:r.scope?r.scope.split(" "):[]}}async function v(e,t){switch(e){case"FACEBOOK_PAGE":return A(t);case"INSTAGRAM_BUSINESS":return g(t);case"GOOGLE_BUSINESS":return I(t);case"EVENTBRITE":return b(t);case"MEETUP":return y(t);default:throw Error(`Unknown provider: ${e}`)}}async function A(e){let t=await fetch(`https://graph.facebook.com/v18.0/me/accounts?access_token=${e}`);if(!t.ok)throw Error("Failed to fetch Facebook pages");let a=await t.json(),r=a.data?.[0];if(!r)throw Error("No Facebook pages found");return{id:r.id,name:r.name,metadata:{pageId:r.id,pageName:r.name,category:r.category,tasks:r.tasks}}}async function g(e){let t=await fetch(`https://graph.facebook.com/v18.0/me/accounts?access_token=${e}`);if(!t.ok)throw Error("Failed to fetch Facebook pages for Instagram");let a=await t.json(),r=a.data?.[0];if(!r)throw Error("No Facebook pages found for Instagram");let o=await fetch(`https://graph.facebook.com/v18.0/${r.id}?fields=instagram_business_account&access_token=${e}`);if(!o.ok)throw Error("Failed to fetch Instagram business account");let s=(await o.json()).instagram_business_account;if(!s)throw Error("No Instagram business account found");return{id:s.id,name:r.name,metadata:{pageId:r.id,pageName:r.name,instagramAccountId:s.id}}}async function I(e){let t=await fetch("https://mybusinessaccountmanagement.googleapis.com/v1/accounts",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw Error("Failed to fetch Google Business accounts");let a=await t.json(),r=a.accounts?.[0];if(!r)throw Error("No Google Business accounts found");return{id:r.name,name:r.accountName,metadata:{accountName:r.accountName,type:r.type}}}async function b(e){let t=await fetch("https://www.eventbriteapi.com/v3/users/me/",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw Error("Failed to fetch Eventbrite user info");let a=await t.json();return{id:a.id,name:a.name,metadata:{email:a.email,firstName:a.first_name,lastName:a.last_name}}}async function y(e){let t=await fetch("https://api.meetup.com/2/member/self",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw Error("Failed to fetch Meetup user info");let a=await t.json();return{id:a.id.toString(),name:a.name,metadata:{city:a.city,country:a.country,state:a.state}}}let S=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/callback/[provider]/route",pathname:"/api/auth/callback/[provider]",filename:"route",bundlePath:"app/api/auth/callback/[provider]/route"},resolvedPagePath:"/Users/kumar/Business admin/tripfluence-admin/app/api/auth/callback/[provider]/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:R,staticGenerationAsyncStorage:x,serverHooks:N}=S,O="/api/auth/callback/[provider]/route";function C(){return(0,n.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:x})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,147,5972,9544],()=>a(41810));module.exports=r})();